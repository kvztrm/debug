local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local settings = {
    enabled = false,
    espEnabled = false,
    fov = 80,
    aimKey = Enum.KeyCode.Q,
    espKey = Enum.KeyCode.Z,
    wallCheckKey = Enum.KeyCode.E,
    aimPart = "Head",
    smoothing = 0.05,
    wallCheck = true,
    teamCheck = false
}

local espBoxes = {}
local target = nil

local function isVisible(player)
    if not settings.wallCheck then return true end
    
    local character = player.Character
    if not character then return false end
    
    local partsToCheck = {
        character:FindFirstChild("Head"),
        character:FindFirstChild("HumanoidRootPart"),
        character:FindFirstChild("UpperTorso") or character:FindFirstChild("Torso")
    }
    
    local origin = Camera.CFrame.Position  -- Camera center/start point
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character, Camera}
    
    for _, part in ipairs(partsToCheck) do
        if part then
            local direction = (part.Position - origin)  -- Straight to target part
            local result = workspace:Raycast(origin, direction, raycastParams)
            
            -- Visible if: no hit OR hit belongs to target's character
            if not result or result.Instance:IsDescendantOf(character) then
                return true
            end
        end
    end
    
    return false  -- Blocked if all rays hit something else
end

local function findTargetInFOV()
    local closestPlayer = nil
    local shortestDistance = settings.fov

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(settings.aimPart) then
            if settings.teamCheck and player.Team == LocalPlayer.Team then continue end
            
            local part = player.Character[settings.aimPart]
            local screenPoint, onScreen = Camera:WorldToScreenPoint(part.Position)
            local distance = (Vector2.new(screenPoint.X, screenPoint.Y) - Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)).Magnitude

            if onScreen and distance < shortestDistance and isVisible(player) then
                closestPlayer = player
                shortestDistance = distance
            end
        end
    end

    return closestPlayer
end

local function aimAtTarget()
    target = findTargetInFOV()
    if target and target.Character and target.Character:FindFirstChild(settings.aimPart) then
        local aimPart = target.Character[settings.aimPart]
        local targetPos = aimPart.Position
        
        local currentCFrame = Camera.CFrame
        local targetCFrame = CFrame.lookAt(currentCFrame.Position, targetPos)
        
        local tween = TweenService:Create(Camera, TweenInfo.new(settings.smoothing), {CFrame = targetCFrame})
        tween:Play()
    end
end

local function toggleESP()
    settings.espEnabled = not settings.espEnabled
    for _, box in pairs(espBoxes) do
        box:Remove()
    end
    espBoxes = {}
end

local function updateESP()
    if not settings.espEnabled then return end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            if espBoxes[player] then continue end
            
            local box = Drawing.new("Square")
            box.Visible = false
            box.Color = Color3.new(1, 0, 0)
            box.Thickness = 2
            box.Transparency = 1
            espBoxes[player] = box
        end
    end
    
    for player, box in pairs(espBoxes) do
        if player.Character and player.Character:FindFirstChild("Head") then
            local head = player.Character.Head
            local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
            
            if onScreen and isVisible(player) then
                box.Size = Vector2.new(1000 / vector.Z, 1500 / vector.Z)
                box.Position = Vector2.new(vector.X - box.Size.X / 2, vector.Y - box.Size.Y)
                box.Visible = true
            else
                box.Visible = false
            end
        else
            box:Remove()
            espBoxes[player] = nil
        end
    end
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == settings.aimKey then
        settings.enabled = not settings.enabled
    elseif input.KeyCode == settings.espKey then
        toggleESP()
    elseif input.KeyCode == settings.wallCheckKey then
        settings.wallCheck = not settings.wallCheck
    end
end)

RunService.Heartbeat:Connect(function()
    if settings.enabled then
        aimAtTarget()
    end
    updateESP()
end)
