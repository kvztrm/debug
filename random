--[[
    Enhanced Aimbot Script - Silent Version
    - Press Q to toggle aimlock on/off
    - Finds closest player ONCE when toggled on
    - Movement prediction for better accuracy
    - Higher frequency updates
    - Tries multiple methods to ensure hits
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- Script State
local aimlockEnabled = false
local aimlockTarget = nil
local detectionRange = 100

-- Store target parts for stable aiming
local targetRoot = nil
local targetHead = nil
local lastHeadPos = nil
local velocityVector = Vector3.new(0, 0, 0)

-- Find closest player to local player
function findClosestPlayer()
    local closestPlayer = nil
    local closestDistance = detectionRange
    
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return nil end
    
    local myRoot = character.HumanoidRootPart
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local rootPart = player.Character.HumanoidRootPart
            local distance = (rootPart.Position - myRoot.Position).Magnitude
            
            if distance < closestDistance then
                closestDistance = distance
                closestPlayer = player
            end
        end
    end
    
    return closestPlayer
end

-- Calculate target velocity for prediction
function updateTargetVelocity()
    if not targetHead then return end
    
    local currentPos = targetHead.Position
    if lastHeadPos then
        velocityVector = currentPos - lastHeadPos
    end
    lastHeadPos = currentPos
end

-- Predict future position (lead the shot)
function predictPosition()
    if not targetHead then return targetHead end
    
    -- Bullet travel time estimation (adjust based on weapon)
    local distance = (targetHead.Position - Camera.CFrame.Position).Magnitude
    local bulletSpeed = 1000 -- Estimate: 1000 studs/sec
    local travelTime = distance / bulletSpeed
    
    -- Lead the target
    local predictedPos = targetHead.Position + (velocityVector * travelTime * 2)
    return predictedPos
end

-- Multiple rapid aim updates
local aimAttempts = 0
local maxAimAttempts = 3

function instantAim()
    if not targetHead then return end
    
    -- Update velocity first
    updateTargetVelocity()
    
    -- Get predicted position
    local predictedPos = predictPosition()
    
    -- Method 1: Direct camera CFrame with prediction
    Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPos)
    Mouse.Hit = CFrame.new(predictedPos)
    
    -- Method 2: Try forcing camera subject change briefly
    local oldSubject = Camera.CameraSubject
    if oldSubject and oldSubject:IsA("Humanoid") then
        pcall(function()
            Camera.CameraSubject = nil
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPos)
            task.wait(0.0001)
            Camera.CameraSubject = oldSubject
        end)
    end
    
    -- Method 3: Rapid successive updates
    aimAttempts = aimAttempts + 1
    if aimAttempts < maxAimAttempts then
        task.defer(function()
            if aimlockEnabled and targetHead then
                Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetHead.Position)
            end
        end)
    else
        aimAttempts = 0
    end
end

-- Use faster RenderStepped for updates
RunService.RenderStepped:Connect(function()
    if aimlockEnabled and targetHead then
        instantAim()
    end
end)

-- Also use Heartbeat for extra updates
RunService.Heartbeat:Connect(function()
    if aimlockEnabled and targetHead then
        instantAim()
    end
end)

-- Toggle with Q
UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Keyboard then
        if input.KeyCode == Enum.KeyCode.Q then
            aimlockEnabled = not aimlockEnabled
            
            if aimlockEnabled then
                -- Find and lock target
                aimlockTarget = findClosestPlayer()
                
                if aimlockTarget and aimlockTarget.Character then
                    targetHead = aimlockTarget.Character:FindFirstChild("Head")
                    targetRoot = aimlockTarget.Character:FindFirstChild("HumanoidRootPart")
                    lastHeadPos = nil
                    velocityVector = Vector3.new(0, 0, 0)
                    
                    -- Multiple instant locks
                    for i = 1, 10 do
                        instantAim()
                        task.wait(0.0001)
                    end
                    
                    game.StarterGui:SetCore("SendNotification", {
                        Title = "LOCKED ON",
                        Text = aimlockTarget.Name,
                        Duration = 2
                    })
                else
                    aimlockEnabled = false
                    targetHead = nil
                    targetRoot = nil
                    game.StarterGui:SetCore("SendNotification", {
                        Title = "No Target",
                        Text = "No players in range",
                        Duration = 2
                    })
                end
            else
                -- Release target
                aimlockEnabled = false
                aimlockTarget = nil
                targetHead = nil
                targetRoot = nil
                game.StarterGui:SetCore("SendNotification", {
                    Title = "Aimbot Off",
                    Text = "Target released",
                    Duration = 2
                })
            end
        end
    end
end)

-- Initial notification
game.StarterGui:SetCore("SendNotification", {
    Title = "Enhanced Aimbot Ready",
    Text = "Press Q to lock onto closest player",
    Duration = 5
})
