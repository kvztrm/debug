-- First: try to clean up the most common inserted script name
pcall(function()
    if workspace:FindFirstChild("Script") then
        workspace.Script:Destroy()
        print("Deleted workspace.Script")
    end
end)

-- ────────────────────────────────────────────────
--                     MAIN SCRIPT
-- ────────────────────────────────────────────────

local Players            = game:GetService("Players")
local RunService         = game:GetService("RunService")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")

local lp        = Players.LocalPlayer
local character = lp.Character or lp.CharacterAdded:Wait()
local humanoid  = character:WaitForChild("Humanoid")

-- Reconnect on respawn
lp.CharacterAdded:Connect(function(newChar)
    character = newChar
    humanoid  = newChar:WaitForChild("Humanoid")
end)

-- Target (case-insensitive partial match)
local targetNamePattern = "relkonta"

-- Remote path (adjust if your game uses different naming)
local remote
pcall(function()
    remote = ReplicatedStorage.Remotes.Requests.SetMenuState
end)

if not remote then
    warn("Could not find SetMenuState remote — script will still teleport but menu won't toggle")
end

local lastHealth = 100

print("Starting loop — targeting players matching: " .. targetNamePattern)

while true do
    -- Find matching player
    local target = nil
    for _, p in ipairs(Players:GetPlayers()) do
        local name  = p.Name:lower()
        local dname = p.DisplayName:lower()
        if name:find(targetNamePattern, 1, true) or dname:find(targetNamePattern, 1, true) then
            if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                target = p.Character
                break
            end
        end
    end

    -- Teleport if we found them
    if target and character and character:FindFirstChild("HumanoidRootPart") then
        local myRoot   = character.HumanoidRootPart
        local targRoot = target.HumanoidRootPart

        -- 1–1.5 stud in front, facing the target
        local forward = targRoot.CFrame.LookVector
        local pos     = targRoot.Position - forward * 1.3
        myRoot.CFrame = CFrame.new(pos, targRoot.Position)
    end

    -- Health drop detection + menu toggle
    local currentHealth = humanoid and humanoid.Health or 100

    if currentHealth < 100 and lastHealth >= 100 then
        if remote then
            pcall(remote.InvokeServer, remote, true)
            task.wait(0.2)
            pcall(remote.InvokeServer, remote, false)
            print("Health < 100 → menu open → close")
        else
            warn("Health dropped but remote not found")
        end
    end

    lastHealth = currentHealth

    -- Don't choke the client — heartbeat is ~fast enough
    RunService.Heartbeat:Wait()
end
